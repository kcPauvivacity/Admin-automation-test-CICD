name: Playwright Tests

on:
  schedule:
    # Run every day at 9 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
  # Also allow manual trigger
  workflow_dispatch:
  # Run on push to main branch
  push:
    branches: [ main, master ]
  # Run on pull requests
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 90  # Increased from 60 to 90 minutes for 253 tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Install dependencies
      run: npm ci
    
    - name: Verify package installation
      run: |
        echo "Installed packages:"
        npm list --depth=0
        echo ""
        echo "Playwright version:"
        npx playwright --version
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Auto-generate tests for new modules (Optional)
      env:
        USERNAME: ${{ secrets.USERNAME }}
        PASSWORD: ${{ secrets.PASSWORD }}
        URL: ${{ secrets.URL }}
      run: |
        echo "ü§ñ Running auto-generation to detect new modules..."
        npm run generate-tests || {
          echo "‚ö†Ô∏è Auto-generation failed or skipped"
          echo "Continuing with existing tests..."
          exit 0
        }
        echo "‚úÖ Auto-generation completed"
        echo ""
        echo "üìä Checking for newly generated tests..."
        ls -la tests/auto-generated/ || echo "No auto-generated tests directory"
      continue-on-error: true
      
    - name: Debug - Check Environment Variables
      run: |
        echo "üîç Checking environment variables..."
        echo "URL is set: ${{ secrets.URL != '' }}"
        echo "USERNAME is set: ${{ secrets.USERNAME != '' }}"
        echo "PASSWORD is set: ${{ secrets.PASSWORD != '' }}"
        echo ""
        echo "Note: Actual values are hidden for security"
      
    - name: Run Playwright tests
      env:
        # Add your test credentials here as GitHub Secrets
        USERNAME: ${{ secrets.USERNAME }}
        PASSWORD: ${{ secrets.PASSWORD }}
        URL: ${{ secrets.URL }}
        CI: true
      run: |
        echo "=== Running tests with configured reporters ==="
        npx playwright test || true
        echo ""
        echo "=== Test run completed ==="
      continue-on-error: true
    
    - name: Check test output
      if: always()
      run: |
        echo "=== Checking generated files ==="
        ls -la
        echo ""
        echo "=== HTML Report ==="
        ls -la playwright-report/ || echo "‚ùå No playwright-report directory"
        echo ""
        echo "=== JSON Results ==="
        if [ -f test-results.json ]; then
          echo "‚úÖ test-results.json found"
          ls -lh test-results.json
        else
          echo "‚ùå test-results.json NOT found"
        fi
        echo ""
        echo "=== Test Results Directory ==="
        ls -la test-results/ || echo "No test-results directory"
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: Upload JSON report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-json
        path: test-results.json
        retention-days: 30
        
    - name: Generate Test Summary
      if: always()
      run: |
        echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f test-results.json ]; then
          node scripts/generate-summary.js >> $GITHUB_STEP_SUMMARY
        else
          echo "Test results file not found" >> $GITHUB_STEP_SUMMARY
        fi
        
    # Send email notification with Nodemailer (optional - will not fail workflow)
    - name: Send email report
      if: always()
      env:
        EMAIL_USER: ${{secrets.EMAIL_USER}}
        EMAIL_PASSWORD: ${{secrets.EMAIL_PASSWORD}}
        EMAIL_RECIPIENTS: ${{secrets.EMAIL_RECIPIENTS}}
      run: |
        # Skip email if secrets are not configured
        if [ -z "$EMAIL_USER" ] || [ -z "$EMAIL_PASSWORD" ] || [ -z "$EMAIL_RECIPIENTS" ]; then
          echo "‚è≠Ô∏è Email secrets not configured - skipping email notification"
          echo "üì• Download test report from Artifacts section below"
          exit 0
        fi
        
        echo "======================================"
        echo "üìß EMAIL REPORT PROCESS"
        echo "======================================"
        echo ""
        echo "=== Installing nodemailer ==="
        npm install nodemailer
        echo ""
        echo "=== Sending email ==="
        node scripts/send-email-report.js || {
          echo "‚ö†Ô∏è Email sending failed"
          echo "üì• Download test report from Artifacts section instead"
          exit 0
        }
        echo ""
        echo "‚úÖ Email sent successfully!"
      continue-on-error: true
