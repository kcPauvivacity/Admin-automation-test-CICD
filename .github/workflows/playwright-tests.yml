name: Playwright Tests

on:
  schedule:
    # Run every day at 9 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
  # Also allow manual trigger
  workflow_dispatch:
  # Run on push to main branch
  push:
    branches: [ main, master ]
  # Run on pull requests
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Install dependencies
      run: npm ci
    
    - name: Verify package installation
      run: |
        echo "Installed packages:"
        npm list --depth=0
        echo ""
        echo "Playwright version:"
        npx playwright --version
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run Playwright tests
      env:
        # Add your test credentials here as GitHub Secrets
        TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        BASE_URL: ${{ secrets.BASE_URL }}
        CI: true
      run: |
        echo "=== Running tests with multiple reporters ==="
        npx playwright test --reporter=list,html,json || true
        echo ""
        echo "=== Test run completed ==="
      continue-on-error: true
    
    - name: Check test output
      if: always()
      run: |
        echo "=== Checking generated files ==="
        ls -la
        echo ""
        echo "=== HTML Report ==="
        ls -la playwright-report/ || echo "‚ùå No playwright-report directory"
        echo ""
        echo "=== JSON Results ==="
        if [ -f test-results.json ]; then
          echo "‚úÖ test-results.json found"
          ls -lh test-results.json
        else
          echo "‚ùå test-results.json NOT found"
        fi
        echo ""
        echo "=== Test Results Directory ==="
        ls -la test-results/ || echo "No test-results directory"
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: Upload JSON report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-json
        path: test-results.json
        retention-days: 30
        
    - name: Generate Test Summary
      if: always()
      run: |
        echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f test-results.json ]; then
          node scripts/generate-summary.js >> $GITHUB_STEP_SUMMARY
        else
          echo "Test results file not found" >> $GITHUB_STEP_SUMMARY
        fi
        
    # Send email notification with Nodemailer
    - name: Send email report
      if: always()
      env:
        EMAIL_USER: ${{secrets.EMAIL_USER}}
        EMAIL_PASSWORD: ${{secrets.EMAIL_PASSWORD}}
        EMAIL_RECIPIENTS: ${{secrets.EMAIL_RECIPIENTS}}
      run: |
        echo "======================================"
        echo "üìß EMAIL REPORT PROCESS"
        echo "======================================"
        echo ""
        echo "=== Step 1: Check Environment Variables ==="
        if [ -z "$EMAIL_USER" ]; then
          echo "‚ùå EMAIL_USER is not set"
        else
          echo "‚úÖ EMAIL_USER is set: ${EMAIL_USER:0:3}***@***"
        fi
        
        if [ -z "$EMAIL_PASSWORD" ]; then
          echo "‚ùå EMAIL_PASSWORD is not set"
        else
          echo "‚úÖ EMAIL_PASSWORD is set (${#EMAIL_PASSWORD} characters)"
        fi
        
        if [ -z "$EMAIL_RECIPIENTS" ]; then
          echo "‚ùå EMAIL_RECIPIENTS is not set"
        else
          echo "‚úÖ EMAIL_RECIPIENTS is set: $EMAIL_RECIPIENTS"
        fi
        
        if [ -z "$EMAIL_USER" ] || [ -z "$EMAIL_PASSWORD" ] || [ -z "$EMAIL_RECIPIENTS" ]; then
          echo ""
          echo "‚ùå ERROR: One or more email secrets are missing!"
          echo "Please add these secrets in GitHub repository settings:"
          echo "  - EMAIL_USER (your Gmail address)"
          echo "  - EMAIL_PASSWORD (Gmail App Password)"
          echo "  - EMAIL_RECIPIENTS (recipient email addresses)"
          echo ""
          echo "Skipping email notification..."
          exit 0
        fi
        
        echo ""
        echo "‚úÖ All email environment variables are set!"
        echo ""
        echo "=== Step 2: Install nodemailer ==="
        npm install nodemailer
        echo ""
        echo "=== Step 3: Check files ==="
        ls -la scripts/send-email-report.js
        ls -la test-results.json 2>/dev/null || echo "‚ö†Ô∏è test-results.json not found (will use defaults)"
        ls -la playwright-report/index.html 2>/dev/null || echo "‚ö†Ô∏è HTML report not found"
        echo ""
        echo "=== Step 4: Send email ==="
        node scripts/send-email-report.js
        echo ""
        echo "======================================"
        echo "‚úÖ Email process completed"
        echo "======================================"
      continue-on-error: true
