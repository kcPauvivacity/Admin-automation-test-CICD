name: Auto-Generate Tests

on:
  schedule:
    # Run every Monday at 8 AM UTC to scan for new modules
    - cron: '0 8 * * 1'
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  auto-generate:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run auto-generation
      env:
        TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        BASE_URL: ${{ secrets.BASE_URL }}
      run: |
        echo "ðŸ¤– Starting auto-generation to scan for new modules..."
        npm run generate-tests
        echo ""
        echo "âœ… Auto-generation completed"
        echo ""
        echo "ðŸ“‹ Generating manual test cases..."
        npm run generate-manual-tests
        echo ""
        echo "âœ… Manual test case generation completed"
        
    - name: Check generated files
      run: |
        echo "ðŸ“Š Generated automated test files:"
        ls -la tests/auto-generated/ || echo "No files generated"
        echo ""
        echo "ï¿½ Generated manual test cases:"
        ls -la manual-test-cases/ || echo "No manual test cases generated"
        echo ""
        echo "ï¿½ðŸ“„ Generation report:"
        cat tests/auto-generated/GENERATION_REPORT.md || echo "No report found"
        echo ""
        echo "ðŸ“„ Manual test summary:"
        cat manual-test-cases/SUMMARY.md || echo "No summary found"
        
    - name: Check for new tests
      id: check-changes
      run: |
        if git diff --quiet tests/auto-generated/ manual-test-cases/; then
          echo "No new tests generated"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "New tests detected!"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Pull Request with new tests
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Auto-generate tests for new modules with manual test cases'
        title: 'ðŸ¤– Auto-generated tests and manual test cases for new modules'
        body: |
          ## Auto-Generated Tests & Manual Test Cases
          
          This PR was automatically created by the test generation workflow.
          
          ### What's included:
          - âœ… New automated test files for detected modules
          - âœ… Updated generation report
          - ðŸ“‹ Manual test cases in multiple formats:
            - Markdown (manual-test-cases.md)
            - Excel/CSV (manual-test-cases.csv)
            - Jira import (jira-import.csv)
            - TestRail import (testrail-import.csv)
          
          ### Manual Test Cases Summary:
          See `manual-test-cases/SUMMARY.md` for detailed breakdown
          
          ### Next steps:
          1. Review the generated automated tests
          2. Review the manual test cases
          3. Customize test scenarios if needed
          4. Import manual tests to your test management tool
          5. Merge to add these tests to the daily CI/CD run
          
          Generated on: ${{ github.run_id }}
        branch: auto-generated-tests-${{ github.run_number }}
        delete-branch: true
        
    - name: Upload generation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generation-report
        path: tests/auto-generated/GENERATION_REPORT.md
        retention-days: 30
        
    - name: Upload manual test cases
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: manual-test-cases
        path: manual-test-cases/
        retention-days: 30
        
    - name: Generate Summary
      if: always()
      run: |
        echo "# Auto-Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f tests/auto-generated/GENERATION_REPORT.md ]; then
          cat tests/auto-generated/GENERATION_REPORT.md >> $GITHUB_STEP_SUMMARY
        else
          echo "No generation report found" >> $GITHUB_STEP_SUMMARY
        fi
