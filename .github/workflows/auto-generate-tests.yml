name: Auto-Generate Tests

on:
  schedule:
    # Run every Monday at 8 AM UTC to scan for new modules
    - cron: '0 8 * * 1'
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  auto-generate:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run auto-generation
      env:
        TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        BASE_URL: ${{ secrets.BASE_URL }}
      run: |
        echo "ðŸ¤– Starting auto-generation to scan for new modules..."
        npm run generate-tests
        echo ""
        echo "âœ… Auto-generation completed"
        
    - name: Check generated files
      run: |
        echo "ðŸ“Š Generated test files:"
        ls -la tests/auto-generated/ || echo "No files generated"
        echo ""
        echo "ðŸ“„ Generation report:"
        cat tests/auto-generated/GENERATION_REPORT.md || echo "No report found"
        
    - name: Check for new tests
      id: check-changes
      run: |
        if git diff --quiet tests/auto-generated/; then
          echo "No new tests generated"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "New tests detected!"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Pull Request with new tests
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Auto-generate tests for new modules'
        title: 'ðŸ¤– Auto-generated tests for new modules'
        body: |
          ## Auto-Generated Tests
          
          This PR was automatically created by the test generation workflow.
          
          ### What's included:
          - New test files for detected modules
          - Updated generation report
          
          ### Next steps:
          1. Review the generated tests
          2. Customize test scenarios if needed
          3. Merge to add these tests to the daily CI/CD run
          
          Generated on: ${{ github.run_id }}
        branch: auto-generated-tests-${{ github.run_number }}
        delete-branch: true
        
    - name: Upload generation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generation-report
        path: tests/auto-generated/GENERATION_REPORT.md
        retention-days: 30
        
    - name: Generate Summary
      if: always()
      run: |
        echo "# Auto-Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f tests/auto-generated/GENERATION_REPORT.md ]; then
          cat tests/auto-generated/GENERATION_REPORT.md >> $GITHUB_STEP_SUMMARY
        else
          echo "No generation report found" >> $GITHUB_STEP_SUMMARY
        fi
